import { ApplicationRef, createComponent, ElementRef, EnvironmentInjector, inject, Injectable, Injector, TemplateRef, } from '@angular/core';
import { BehaviorSubject, Subject } from 'rxjs';
import { DialogRef, InternalDialogRef } from './dialog-ref';
import { DialogComponent } from './dialog.component';
import { DIALOG_DOCUMENT_REF, GLOBAL_DIALOG_CONFIG, NODES_TO_INSERT } from './providers';
import * as i0 from "@angular/core";
const OVERFLOW_HIDDEN_CLASS = 'ngx-dialog-hidden';
export class NgxDialog {
    constructor() {
        this.appRef = inject(ApplicationRef);
        this.injector = inject(EnvironmentInjector);
        this.document = inject(DIALOG_DOCUMENT_REF);
        this.globalConfig = inject(GLOBAL_DIALOG_CONFIG);
        this.dialogs = [];
        this.hasOpenDialogSub = new BehaviorSubject(false);
        this.hasOpenDialogs$ = this.hasOpenDialogSub.asObservable();
    }
    hasOpenDialogs() {
        return this.dialogs.length > 0;
    }
    isOpen(id) {
        return this.dialogs.some((ref) => ref.id === id);
    }
    isLastOpened(idOrRef) {
        const id = idOrRef instanceof DialogRef ? idOrRef.id : idOrRef;
        return this.dialogs.at(-1)?.id === id;
    }
    closeAll() {
        this.dialogs.forEach((dialog) => dialog.close());
    }
    open(componentOrTemplate, config = {}) {
        const mergedConfig = this.mergeConfig(config);
        if (isComponent(componentOrTemplate)) {
            mergedConfig.id ??= componentOrTemplate.name;
        }
        const dialogRef = new InternalDialogRef({
            config: mergedConfig,
            backdropClick$: new Subject(),
        });
        const attachOptions = isTemplate(componentOrTemplate)
            ? this.openTemplate(componentOrTemplate, dialogRef)
            : isComponent(componentOrTemplate)
                ? this.openComponent(componentOrTemplate, dialogRef)
                : throwMustBeAComponentOrATemplateRef(componentOrTemplate);
        if (this.isOpen(dialogRef.id)) {
            attachOptions.view.destroy();
        }
        mergedConfig.onOpen?.();
        this.dialogs.push(dialogRef);
        this.hasOpenDialogSub.next(true);
        if (this.dialogs.length === 1) {
            this.document.body.classList.add(OVERFLOW_HIDDEN_CLASS);
        }
        return this.attach(dialogRef, attachOptions);
    }
    openTemplate(template, dialogRef) {
        const config = dialogRef.config;
        const context = {
            $implicit: dialogRef,
            config,
        };
        const view = config.vcr?.createEmbeddedView(template, context) || template.createEmbeddedView(context);
        return {
            ref: template,
            view,
            attachToApp: !config.vcr,
        };
    }
    openComponent(Component, dialogRef) {
        const componentRef = createComponent(Component, {
            elementInjector: Injector.create({
                providers: [
                    {
                        provide: DialogRef,
                        useValue: dialogRef,
                    },
                ],
                parent: dialogRef.config.vcr?.injector || this.injector,
            }),
            environmentInjector: this.injector,
        });
        return {
            ref: componentRef,
            view: componentRef.hostView,
            attachToApp: true,
        };
    }
    attach(dialogRef, { ref, view, attachToApp }) {
        const dialog = this.createDialog(dialogRef, view);
        const container = getNativeElement(dialogRef.config.container);
        const hooks = {
            after: new Subject(),
        };
        const onClose = (result) => {
            this.globalConfig.onClose?.();
            this.dialogs = this.dialogs.filter(({ id }) => dialogRef.id !== id);
            this.hasOpenDialogSub.next(this.hasOpenDialogs());
            container.removeChild(dialog.location.nativeElement);
            this.appRef.detachView(dialog.hostView);
            this.appRef.detachView(view);
            dialog.destroy();
            view.destroy();
            hooks.after.next(result);
            hooks.after.complete();
            if (!this.hasOpenDialogs()) {
                this.document.body.classList.remove(OVERFLOW_HIDDEN_CLASS);
            }
        };
        const onReset = (offset) => {
            dialog.instance.reset(offset);
        };
        dialogRef.mutate({
            ref,
            onClose,
            afterClosed$: hooks.after.asObservable(),
            onReset,
        });
        container.appendChild(dialog.location.nativeElement);
        this.appRef.attachView(dialog.hostView);
        if (attachToApp) {
            this.appRef.attachView(view);
        }
        return dialogRef.asDialogRef();
    }
    createDialog(dialogRef, view) {
        return createComponent(DialogComponent, {
            elementInjector: Injector.create({
                providers: [
                    {
                        provide: InternalDialogRef,
                        useValue: dialogRef,
                    },
                    {
                        provide: NODES_TO_INSERT,
                        useValue: view.rootNodes,
                    },
                ],
                parent: this.injector,
            }),
            environmentInjector: this.injector,
        });
    }
    mergeConfig(inlineConfig) {
        return {
            ...this.globalConfig,
            ...inlineConfig,
            sizes: this.globalConfig?.sizes,
        };
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: NgxDialog, deps: [], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: NgxDialog, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "16.2.12", ngImport: i0, type: NgxDialog, decorators: [{
            type: Injectable,
            args: [{ providedIn: 'root' }]
        }] });
function throwMustBeAComponentOrATemplateRef(value) {
    throw new TypeError(`Dialog must receive a Component or a TemplateRef, but this has been passed instead: ${value}`);
}
function getNativeElement(element) {
    return element instanceof ElementRef ? element.nativeElement : element;
}
function isTemplate(tplOrComp) {
    return tplOrComp instanceof TemplateRef;
}
function isComponent(tplOrComp) {
    return !isTemplate(tplOrComp) && typeof tplOrComp === 'function';
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGlhbG9nLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9uZ3gtZWFnbGUvZGlhbG9nL2RpYWxvZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFDTCxjQUFjLEVBQ2QsZUFBZSxFQUNmLFVBQVUsRUFDVixtQkFBbUIsRUFDbkIsTUFBTSxFQUNOLFVBQVUsRUFDVixRQUFRLEVBQ1IsV0FBVyxHQUdaLE1BQU0sZUFBZSxDQUFDO0FBQ3ZCLE9BQU8sRUFBRSxlQUFlLEVBQUUsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBRWhELE9BQU8sRUFBRSxTQUFTLEVBQUUsaUJBQWlCLEVBQUUsTUFBTSxjQUFjLENBQUM7QUFDNUQsT0FBTyxFQUFFLGVBQWUsRUFBRSxNQUFNLG9CQUFvQixDQUFDO0FBRXJELE9BQU8sRUFBRSxtQkFBbUIsRUFBRSxvQkFBb0IsRUFBRSxlQUFlLEVBQUUsTUFBTSxhQUFhLENBQUM7O0FBR3pGLE1BQU0scUJBQXFCLEdBQUcsbUJBQW1CLENBQUM7QUFHbEQsTUFBTSxPQUFPLFNBQVM7SUFEdEI7UUFFVSxXQUFNLEdBQUcsTUFBTSxDQUFDLGNBQWMsQ0FBQyxDQUFDO1FBQ2hDLGFBQVEsR0FBRyxNQUFNLENBQUMsbUJBQW1CLENBQUMsQ0FBQztRQUN2QyxhQUFRLEdBQUcsTUFBTSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDdkMsaUJBQVksR0FBRyxNQUFNLENBQUMsb0JBQW9CLENBQUMsQ0FBQztRQUVwRCxZQUFPLEdBQWdCLEVBQUUsQ0FBQztRQUNsQixxQkFBZ0IsR0FBRyxJQUFJLGVBQWUsQ0FBVSxLQUFLLENBQUMsQ0FBQztRQUMvRCxvQkFBZSxHQUFHLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxZQUFZLEVBQUUsQ0FBQztLQStKeEQ7SUE3SkMsY0FBYztRQUNaLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFDO0lBQ2pD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MUMsQ0FBQztBQUVELFNBQVMsV0FBVyxDQUFDLFNBQWM7SUFDakMsT0FBTyxDQUFDLFVBQVUsQ0FBQyxTQUFTLENBQUMsSUFBSSxPQUFPLFNBQVMsS0FBSyxVQUFVLENBQUM7QUFDbkUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XHJcbiAgQXBwbGljYXRpb25SZWYsXHJcbiAgY3JlYXRlQ29tcG9uZW50LFxyXG4gIEVsZW1lbnRSZWYsXHJcbiAgRW52aXJvbm1lbnRJbmplY3RvcixcclxuICBpbmplY3QsXHJcbiAgSW5qZWN0YWJsZSxcclxuICBJbmplY3RvcixcclxuICBUZW1wbGF0ZVJlZixcclxuICBUeXBlLFxyXG4gIFZpZXdSZWYsXHJcbn0gZnJvbSAnQGFuZ3VsYXIvY29yZSc7XHJcbmltcG9ydCB7IEJlaGF2aW9yU3ViamVjdCwgU3ViamVjdCB9IGZyb20gJ3J4anMnO1xyXG5cclxuaW1wb3J0IHsgRGlhbG9nUmVmLCBJbnRlcm5hbERpYWxvZ1JlZiB9IGZyb20gJy4vZGlhbG9nLXJlZic7XHJcbmltcG9ydCB7IERpYWxvZ0NvbXBvbmVudCB9IGZyb20gJy4vZGlhbG9nLmNvbXBvbmVudCc7XHJcbmltcG9ydCB7IERyYWdPZmZzZXQgfSBmcm9tICcuL2RyYWdnYWJsZS5kaXJlY3RpdmUnO1xyXG5pbXBvcnQgeyBESUFMT0dfRE9DVU1FTlRfUkVGLCBHTE9CQUxfRElBTE9HX0NPTkZJRywgTk9ERVNfVE9fSU5TRVJUIH0gZnJvbSAnLi9wcm92aWRlcnMnO1xyXG5pbXBvcnQgeyBBdHRhY2hPcHRpb25zLCBEaWFsb2dDb25maWcsIEV4dHJhY3REYXRhLCBFeHRyYWN0UmVzdWx0LCBHbG9iYWxEaWFsb2dDb25maWcgfSBmcm9tICcuL3R5cGVzJztcclxuXHJcbmNvbnN0IE9WRVJGTE9XX0hJRERFTl9DTEFTUyA9ICduZ3gtZGlhbG9nLWhpZGRlbic7XHJcblxyXG5ASW5qZWN0YWJsZSh7IHByb3ZpZGVkSW46ICdyb290JyB9KVxyXG5leHBvcnQgY2xhc3MgTmd4RGlhbG9nIHtcclxuICBwcml2YXRlIGFwcFJlZiA9IGluamVjdChBcHBsaWNhdGlvblJlZik7XHJcbiAgcHJpdmF0ZSBpbmplY3RvciA9IGluamVjdChFbnZpcm9ubWVudEluamVjdG9yKTtcclxuICBwcml2YXRlIGRvY3VtZW50ID0gaW5qZWN0KERJQUxPR19ET0NVTUVOVF9SRUYpO1xyXG4gIHByaXZhdGUgZ2xvYmFsQ29uZmlnID0gaW5qZWN0KEdMT0JBTF9ESUFMT0dfQ09ORklHKTtcclxuXHJcbiAgZGlhbG9nczogRGlhbG9nUmVmW10gPSBbXTtcclxuICBwcml2YXRlIGhhc09wZW5EaWFsb2dTdWIgPSBuZXcgQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+KGZhbHNlKTtcclxuICBoYXNPcGVuRGlhbG9ncyQgPSB0aGlzLmhhc09wZW5EaWFsb2dTdWIuYXNPYnNlcnZhYmxlKCk7XHJcblxyXG4gIGhhc09wZW5EaWFsb2dzKCkge1xyXG4gICAgcmV0dXJuIHRoaXMuZGlhbG9ncy5sZW5ndGggPiAwO1xyXG4gIH1cclxuXHJcbiAgaXNPcGVuKGlkOiBzdHJpbmcpIHtcclxuICAgIHJldHVybiB0aGlzLmRpYWxvZ3Muc29tZSgocmVmKSA9PiByZWYuaWQgPT09IGlkKTtcclxuICB9XHJcblxyXG4gIGlzTGFzdE9wZW5lZChpZE9yUmVmOiBzdHJpbmcgfCBEaWFsb2dSZWYpOiBib29sZWFuIHtcclxuICAgIGNvbnN0IGlkID0gaWRPclJlZiBpbnN0YW5jZW9mIERpYWxvZ1JlZiA/IGlkT3JSZWYuaWQgOiBpZE9yUmVmO1xyXG4gICAgcmV0dXJuIHRoaXMuZGlhbG9ncy5hdCgtMSk/LmlkID09PSBpZDtcclxuICB9XHJcblxyXG4gIGNsb3NlQWxsKCkge1xyXG4gICAgdGhpcy5kaWFsb2dzLmZvckVhY2goKGRpYWxvZykgPT4gZGlhbG9nLmNsb3NlKCkpO1xyXG4gIH1cclxuXHJcbiAgb3Blbih0ZW1wbGF0ZTogVGVtcGxhdGVSZWY8YW55PiwgY29uZmlnPzogUGFydGlhbDxEaWFsb2dDb25maWc+KTogRGlhbG9nUmVmO1xyXG4gIG9wZW48QyBleHRlbmRzIFR5cGU8YW55Pj4oXHJcbiAgICBjb21wb25lbnQ6IEMsXHJcbiAgICBjb25maWc/OiBQYXJ0aWFsPERpYWxvZ0NvbmZpZzxFeHRyYWN0RGF0YTxJbnN0YW5jZVR5cGU8Qz4+Pj4sXHJcbiAgKTogRGlhbG9nUmVmPEV4dHJhY3REYXRhPEluc3RhbmNlVHlwZTxDPj4sIEV4dHJhY3RSZXN1bHQ8SW5zdGFuY2VUeXBlPEM+Pj47XHJcbiAgb3Blbihjb21wb25lbnRPclRlbXBsYXRlOiBhbnksIGNvbmZpZzogUGFydGlhbDxEaWFsb2dDb25maWc+ID0ge30pOiBEaWFsb2dSZWYge1xyXG4gICAgY29uc3QgbWVyZ2VkQ29uZmlnID0gdGhpcy5tZXJnZUNvbmZpZyhjb25maWcpO1xyXG5cclxuICAgIGlmIChpc0NvbXBvbmVudChjb21wb25lbnRPclRlbXBsYXRlKSkge1xyXG4gICAgICBtZXJnZWRDb25maWcuaWQgPz89IGNvbXBvbmVudE9yVGVtcGxhdGUubmFtZTtcclxuICAgIH1cclxuXHJcbiAgICBjb25zdCBkaWFsb2dSZWYgPSBuZXcgSW50ZXJuYWxEaWFsb2dSZWYoe1xyXG4gICAgICBjb25maWc6IG1lcmdlZENvbmZpZyxcclxuICAgICAgYmFja2Ryb3BDbGljayQ6IG5ldyBTdWJqZWN0PE1vdXNlRXZlbnQ+KCksXHJcbiAgICB9KTtcclxuXHJcbiAgICBjb25zdCBhdHRhY2hPcHRpb25zID0gaXNUZW1wbGF0ZShjb21wb25lbnRPclRlbXBsYXRlKVxyXG4gICAgICA/IHRoaXMub3BlblRlbXBsYXRlKGNvbXBvbmVudE9yVGVtcGxhdGUsIGRpYWxvZ1JlZilcclxuICAgICAgOiBpc0NvbXBvbmVudChjb21wb25lbnRPclRlbXBsYXRlKVxyXG4gICAgICA/IHRoaXMub3BlbkNvbXBvbmVudChjb21wb25lbnRPclRlbXBsYXRlLCBkaWFsb2dSZWYpXHJcbiAgICAgIDogdGhyb3dNdXN0QmVBQ29tcG9uZW50T3JBVGVtcGxhdGVSZWYoY29tcG9uZW50T3JUZW1wbGF0ZSk7XHJcblxyXG4gICAgaWYgKHRoaXMuaXNPcGVuKGRpYWxvZ1JlZi5pZCkpIHtcclxuICAgICAgYXR0YWNoT3B0aW9ucy52aWV3LmRlc3Ryb3koKTtcclxuICAgIH1cclxuXHJcbiAgICBtZXJnZWRDb25maWcub25PcGVuPy4oKTtcclxuICAgIHRoaXMuZGlhbG9ncy5wdXNoKGRpYWxvZ1JlZik7XHJcbiAgICB0aGlzLmhhc09wZW5EaWFsb2dTdWIubmV4dCh0cnVlKTtcclxuICAgIGlmICh0aGlzLmRpYWxvZ3MubGVuZ3RoID09PSAxKSB7XHJcbiAgICAgIHRoaXMuZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QuYWRkKE9WRVJGTE9XX0hJRERFTl9DTEFTUyk7XHJcbiAgICB9XHJcbiAgICByZXR1cm4gdGhpcy5hdHRhY2goZGlhbG9nUmVmLCBhdHRhY2hPcHRpb25zKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgb3BlblRlbXBsYXRlKHRlbXBsYXRlOiBUZW1wbGF0ZVJlZjxhbnk+LCBkaWFsb2dSZWY6IEludGVybmFsRGlhbG9nUmVmKSB7XHJcbiAgICBjb25zdCBjb25maWcgPSBkaWFsb2dSZWYuY29uZmlnO1xyXG4gICAgY29uc3QgY29udGV4dCA9IHtcclxuICAgICAgJGltcGxpY2l0OiBkaWFsb2dSZWYsXHJcbiAgICAgIGNvbmZpZyxcclxuICAgIH07XHJcbiAgICBjb25zdCB2aWV3ID0gY29uZmlnLnZjcj8uY3JlYXRlRW1iZWRkZWRWaWV3KHRlbXBsYXRlLCBjb250ZXh0KSB8fCB0ZW1wbGF0ZS5jcmVhdGVFbWJlZGRlZFZpZXcoY29udGV4dCk7XHJcbiAgICByZXR1cm4ge1xyXG4gICAgICByZWY6IHRlbXBsYXRlLFxyXG4gICAgICB2aWV3LFxyXG4gICAgICBhdHRhY2hUb0FwcDogIWNvbmZpZy52Y3IsXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBvcGVuQ29tcG9uZW50KENvbXBvbmVudDogVHlwZTxhbnk+LCBkaWFsb2dSZWY6IEludGVybmFsRGlhbG9nUmVmKSB7XHJcbiAgICBjb25zdCBjb21wb25lbnRSZWYgPSBjcmVhdGVDb21wb25lbnQoQ29tcG9uZW50LCB7XHJcbiAgICAgIGVsZW1lbnRJbmplY3RvcjogSW5qZWN0b3IuY3JlYXRlKHtcclxuICAgICAgICBwcm92aWRlcnM6IFtcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgcHJvdmlkZTogRGlhbG9nUmVmLFxyXG4gICAgICAgICAgICB1c2VWYWx1ZTogZGlhbG9nUmVmLFxyXG4gICAgICAgICAgfSxcclxuICAgICAgICBdLFxyXG4gICAgICAgIHBhcmVudDogZGlhbG9nUmVmLmNvbmZpZy52Y3I/LmluamVjdG9yIHx8IHRoaXMuaW5qZWN0b3IsXHJcbiAgICAgIH0pLFxyXG4gICAgICBlbnZpcm9ubWVudEluamVjdG9yOiB0aGlzLmluamVjdG9yLFxyXG4gICAgfSk7XHJcblxyXG4gICAgcmV0dXJuIHtcclxuICAgICAgcmVmOiBjb21wb25lbnRSZWYsXHJcbiAgICAgIHZpZXc6IGNvbXBvbmVudFJlZi5ob3N0VmlldyxcclxuICAgICAgYXR0YWNoVG9BcHA6IHRydWUsXHJcbiAgICB9O1xyXG4gIH1cclxuXHJcbiAgcHJpdmF0ZSBhdHRhY2goZGlhbG9nUmVmOiBJbnRlcm5hbERpYWxvZ1JlZiwgeyByZWYsIHZpZXcsIGF0dGFjaFRvQXBwIH06IEF0dGFjaE9wdGlvbnMpOiBEaWFsb2dSZWY8YW55LCBhbnksIGFueT4ge1xyXG4gICAgY29uc3QgZGlhbG9nID0gdGhpcy5jcmVhdGVEaWFsb2coZGlhbG9nUmVmLCB2aWV3KTtcclxuXHJcbiAgICBjb25zdCBjb250YWluZXIgPSBnZXROYXRpdmVFbGVtZW50KGRpYWxvZ1JlZi5jb25maWcuY29udGFpbmVyKTtcclxuXHJcbiAgICBjb25zdCBob29rcyA9IHtcclxuICAgICAgYWZ0ZXI6IG5ldyBTdWJqZWN0PHVua25vd24+KCksXHJcbiAgICB9O1xyXG5cclxuICAgIGNvbnN0IG9uQ2xvc2UgPSAocmVzdWx0OiB1bmtub3duKSA9PiB7XHJcbiAgICAgIHRoaXMuZ2xvYmFsQ29uZmlnLm9uQ2xvc2U/LigpO1xyXG4gICAgICB0aGlzLmRpYWxvZ3MgPSB0aGlzLmRpYWxvZ3MuZmlsdGVyKCh7IGlkIH0pID0+IGRpYWxvZ1JlZi5pZCAhPT0gaWQpO1xyXG4gICAgICB0aGlzLmhhc09wZW5EaWFsb2dTdWIubmV4dCh0aGlzLmhhc09wZW5EaWFsb2dzKCkpO1xyXG5cclxuICAgICAgY29udGFpbmVyLnJlbW92ZUNoaWxkKGRpYWxvZy5sb2NhdGlvbi5uYXRpdmVFbGVtZW50KTtcclxuICAgICAgdGhpcy5hcHBSZWYuZGV0YWNoVmlldyhkaWFsb2cuaG9zdFZpZXcpO1xyXG4gICAgICB0aGlzLmFwcFJlZi5kZXRhY2hWaWV3KHZpZXcpO1xyXG4gICAgICBkaWFsb2cuZGVzdHJveSgpO1xyXG4gICAgICB2aWV3LmRlc3Ryb3koKTtcclxuICAgICAgaG9va3MuYWZ0ZXIubmV4dChyZXN1bHQpO1xyXG4gICAgICBob29rcy5hZnRlci5jb21wbGV0ZSgpO1xyXG4gICAgICBpZiAoIXRoaXMuaGFzT3BlbkRpYWxvZ3MoKSkge1xyXG4gICAgICAgIHRoaXMuZG9jdW1lbnQuYm9keS5jbGFzc0xpc3QucmVtb3ZlKE9WRVJGTE9XX0hJRERFTl9DTEFTUyk7XHJcbiAgICAgIH1cclxuICAgIH07XHJcbiAgICBjb25zdCBvblJlc2V0ID0gKG9mZnNldD86IERyYWdPZmZzZXQpID0+IHtcclxuICAgICAgZGlhbG9nLmluc3RhbmNlLnJlc2V0KG9mZnNldCk7XHJcbiAgICB9O1xyXG5cclxuICAgIGRpYWxvZ1JlZi5tdXRhdGUoe1xyXG4gICAgICByZWYsXHJcbiAgICAgIG9uQ2xvc2UsXHJcbiAgICAgIGFmdGVyQ2xvc2VkJDogaG9va3MuYWZ0ZXIuYXNPYnNlcnZhYmxlKCksXHJcbiAgICAgIG9uUmVzZXQsXHJcbiAgICB9KTtcclxuICAgIGNvbnRhaW5lci5hcHBlbmRDaGlsZChkaWFsb2cubG9jYXRpb24ubmF0aXZlRWxlbWVudCk7XHJcbiAgICB0aGlzLmFwcFJlZi5hdHRhY2hWaWV3KGRpYWxvZy5ob3N0Vmlldyk7XHJcbiAgICBpZiAoYXR0YWNoVG9BcHApIHtcclxuICAgICAgdGhpcy5hcHBSZWYuYXR0YWNoVmlldyh2aWV3KTtcclxuICAgIH1cclxuICAgIHJldHVybiBkaWFsb2dSZWYuYXNEaWFsb2dSZWYoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY3JlYXRlRGlhbG9nKGRpYWxvZ1JlZjogSW50ZXJuYWxEaWFsb2dSZWYsIHZpZXc6IFZpZXdSZWYpIHtcclxuICAgIHJldHVybiBjcmVhdGVDb21wb25lbnQoRGlhbG9nQ29tcG9uZW50LCB7XHJcbiAgICAgIGVsZW1lbnRJbmplY3RvcjogSW5qZWN0b3IuY3JlYXRlKHtcclxuICAgICAgICBwcm92aWRlcnM6IFtcclxuICAgICAgICAgIHtcclxuICAgICAgICAgICAgcHJvdmlkZTogSW50ZXJuYWxEaWFsb2dSZWYsXHJcbiAgICAgICAgICAgIHVzZVZhbHVlOiBkaWFsb2dSZWYsXHJcbiAgICAgICAgICB9LFxyXG4gICAgICAgICAge1xyXG4gICAgICAgICAgICBwcm92aWRlOiBOT0RFU19UT19JTlNFUlQsXHJcbiAgICAgICAgICAgIHVzZVZhbHVlOiAodmlldyBhcyBhbnkpLnJvb3ROb2RlcyxcclxuICAgICAgICAgIH0sXHJcbiAgICAgICAgXSxcclxuICAgICAgICBwYXJlbnQ6IHRoaXMuaW5qZWN0b3IsXHJcbiAgICAgIH0pLFxyXG4gICAgICBlbnZpcm9ubWVudEluamVjdG9yOiB0aGlzLmluamVjdG9yLFxyXG4gICAgfSk7XHJcbiAgfVxyXG5cclxuICBwcml2YXRlIG1lcmdlQ29uZmlnKGlubGluZUNvbmZpZzogUGFydGlhbDxEaWFsb2dDb25maWc+KTogRGlhbG9nQ29uZmlnICYgR2xvYmFsRGlhbG9nQ29uZmlnIHtcclxuICAgIHJldHVybiB7XHJcbiAgICAgIC4uLnRoaXMuZ2xvYmFsQ29uZmlnLFxyXG4gICAgICAuLi5pbmxpbmVDb25maWcsXHJcbiAgICAgIHNpemVzOiB0aGlzLmdsb2JhbENvbmZpZz8uc2l6ZXMsXHJcbiAgICB9IGFzIERpYWxvZ0NvbmZpZyAmIEdsb2JhbERpYWxvZ0NvbmZpZztcclxuICB9XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHRocm93TXVzdEJlQUNvbXBvbmVudE9yQVRlbXBsYXRlUmVmKHZhbHVlOiB1bmtub3duKTogbmV2ZXIge1xyXG4gIHRocm93IG5ldyBUeXBlRXJyb3IoYERpYWxvZyBtdXN0IHJlY2VpdmUgYSBDb21wb25lbnQgb3IgYSBUZW1wbGF0ZVJlZiwgYnV0IHRoaXMgaGFzIGJlZW4gcGFzc2VkIGluc3RlYWQ6ICR7dmFsdWV9YCk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldE5hdGl2ZUVsZW1lbnQoZWxlbWVudDogRWxlbWVudCB8IEVsZW1lbnRSZWYpOiBFbGVtZW50IHtcclxuICByZXR1cm4gZWxlbWVudCBpbnN0YW5jZW9mIEVsZW1lbnRSZWYgPyBlbGVtZW50Lm5hdGl2ZUVsZW1lbnQgOiBlbGVtZW50O1xyXG59XHJcblxyXG5mdW5jdGlvbiBpc1RlbXBsYXRlKHRwbE9yQ29tcDogYW55KTogdHBsT3JDb21wIGlzIFRlbXBsYXRlUmVmPGFueT4ge1xyXG4gIHJldHVybiB0cGxPckNvbXAgaW5zdGFuY2VvZiBUZW1wbGF0ZVJlZjtcclxufVxyXG5cclxuZnVuY3Rpb24gaXNDb21wb25lbnQodHBsT3JDb21wOiBhbnkpOiB0cGxPckNvbXAgaXMgVHlwZTxhbnk+IHtcclxuICByZXR1cm4gIWlzVGVtcGxhdGUodHBsT3JDb21wKSAmJiB0eXBlb2YgdHBsT3JDb21wID09PSAnZnVuY3Rpb24nO1xyXG59XHJcbiJdfQ==